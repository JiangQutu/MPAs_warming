---
title: "MPA and climate change: plotting"
output: html_notebook
author: Mark Ruddy 
date: 2017-04-20
---


## Task summary

The project aims to look at projected climate warming in Marine Protected Areas. It uses climate models ([CMIP5](http://cmip-pcmdi.llnl.gov/cmip5/)) run for two emission scenarios (Representative Concentration Pathways - [RCPs](https://www.skepticalscience.com/rcp.php?t=1)) - 4.5degC and 8.5degC - developed as part of Intergovernmental Panel on Climate Change's (IPCC) Fifth Assessment Report ([AR5](http://www.ipcc-data.org/sim/gcm_monthly/AR5/)).

As part of the study, the temperature data need to be modified to exclude land-based temperature measures. Additionally, adequate maps of the data need to be created.

This notebook will provide plots of SST with land surface removed (white or black) and a pleasing SST key.

## Setup

```{r}
# Packages
library(dplyr) # Data wrangling and exploration
library(tidyr) # Data wrangling
library(raster) # Dealing with rasters
library(ncdf4) # Required - viewing and working with climate data in netCDF format
```

## Datasets

Marine Protected Areas
```{r}
mpas <- read.csv("../nn_extractedA2c.csv", header = TRUE)
# glimpse(mpas) # Peek at the data
```

Read CMIP5 RCP8.5 mean
```{r}
name85 <- "../trend_yearmean_ensemble_tos_RCP85.nc"
mean85 <- raster(name85) # Read in raster
map.extent <- c(-180, 180, -90, 90) # Reset for layer, orginal orientation was 0-360 longitude
extent(mean85) <- map.extent # Change extent

source("../revrotate..R") # Rotate raster layer to align with MPA points
mean85 <- revrotate(mean85)
extent(mean85) <- map.extent
rm("name85", "map.extent")
```

## Plotting

### Test plot temperature raster and MPAs - baseR
```{r}
plot(mean85, main = ("RCP 8.5 warming rate for mean SST"), ylim = c(-71.2, 71.2), col=rev(rainbow(200, start=.8, end=.23))) 
points(mpas[,2:3], pch = 10, cex = 0.3) 
```

### Test plot temperature raster and MPAs - rasterVis

```{r}
# library(rasterVis) # Plotting rasters 
pts <- mpas[,2:3] # MPA points
levelplot(mean85, margin = FALSE, par.settings = viridisTheme()) + 
  layer(sp.points(pts, pch = 10, cex = 0.3))
# ERROR THROWN: 'Error using packet 1 any(sp) is not TRUE'
# Problem somehwere with plotting points as `latticeExtra::layer` 
# Can't find solution at moment so will abandon using `rasterVis`
rm("pts")
```


### Test plot temperature raster and MPAs - ggplot2

```{r plot-world-gg}
# library(ggplot2) # Graphics
# library(rasterVis) # Handling netCDF
# library(viridis) # viridis colour scales for perceptually uniform palettes. See https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html

p <- gplot(mean85) + # Note: uses `gplot` here not `ggplot` - uses `rasterVis`
  geom_raster(aes(fill = value)) +
  scale_fill_viridis(direction = -1, option = "plasma", breaks = seq(0.02, 0.16, 0.02)) +
  geom_point(data = mpas, mapping = aes(x = Centroid_Longitude, y = Centroid_Latitude), size = 0.1, colour = "black") + 
  guides(fill = guide_colorbar(title = expression(paste(degree, C,"/year")), barheight = 16, raster = TRUE)) + 
  theme(legend.title = element_text(size = 9)) +
  ggtitle("RCP 8.5 warming rate for mean SST") + 
  xlab("Longitude") +
  ylab("Latitude") +
  scale_y_continuous(breaks = seq(-80, 80, 40), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-180, 180, 60), expand = c(0,0)) + 
  geom_hline(yintercept = c(-66.5, -40, -23.5, 23.5, 40, 66.5), linetype = 2, size = 0.3)

p
```


### Plot with added land surface layer

1. Obtain world land surface raster data

Read in [Natural Earth](http://www.naturalearthdata.com/) 1:110m world vector, then convert to simple raster.

```{r get-land-vector}
# Natural Earth 110m data. Comes as zip file 
url <- "http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/110m/physical/ne_110m_land.zip" # Land vector map web location

localDir <- "../land"

if (!file.exists(localDir)) {
  dir.create(localDir)
}

dwnld <- paste(localDir, basename(url), sep = "/") # zip file destination

if (!file.exists(dwnld)) {
  download.file(url = url, destfile = dwnld, method = "auto") # download from web
  unzip(dwnld, exdir = localDir) # unzip
}

list.files(localDir) # check unzip

# rm("url", "localDir", "dwnld") # clean up workspace
```

2. Read in land surface vector

```{r read-land-vector}
library(rgdal) # For working with shapefiles
# localDir object from chunk `get-land-vector`. Alternatively, specify location of the land vector shapefile.

land <- readOGR(dsn = localDir) # Read in shapefile using `rgdal`. No need to specify shapefile name as there's only one in the directory we created above.

land.gg <- fortify(land) # Convert shapefile to data_frame useable by ggplot. `Fortify` may be deprecated in the future and the `broom` package should be used.

str(land.gg)

# Test plot land
ggplot(data = land.gg, aes(x = long, y = lat, group = group)) + # Group is important. Tells ggplot to draw as separate not single polygons
  geom_polygon()

rm("land")
```

3. Plot Earth polygon over temperature raster

```{r}
p.land <- gplot(mean85.sst) + # Note: uses `gplot` here not `ggplot` - uses `rasterVis`
  geom_raster(aes(fill = value)) +
  scale_fill_viridis(direction = -1, option = "plasma", breaks = seq(0.02, 0.16, 0.02)) +
  geom_polygon(data = land.gg, aes(x = long, y = lat, group = group), fill = "white") +
  geom_point(data = mpas, mapping = aes(x = Centroid_Longitude, y = Centroid_Latitude), size = 0.1, colour = "black") + 
  guides(fill = guide_colorbar(title = expression(paste(degree, C,"/year")), barheight = 16, raster = TRUE)) + 
  theme(legend.title = element_text(size = 9)) +
  ggtitle("RCP 8.5 warming rate for mean SST") + 
  xlab("Longitude") +
  ylab("Latitude") +
  scale_y_continuous(breaks = seq(-80, 80, 40), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(-180, 180, 60), expand = c(0,0)) + 
  geom_hline(yintercept = c(-66.5, -40, -23.5, 23.5, 40, 66.5), linetype = 2, size = 0.3)

p.land
```















