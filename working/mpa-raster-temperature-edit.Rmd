---
title: "MPAs and climate change: land surface temperature removal"
output: html_notebook
author: Mark Ruddy
date: 2017-04-22
---

## Task summary

The project aims to look at projected climate warming in Marine Protected Areas. It uses climate models ([CMIP5](http://cmip-pcmdi.llnl.gov/cmip5/)) run for two emission scenarios (Representative Concentration Pathways - [RCPs](https://www.skepticalscience.com/rcp.php?t=1)) - 4.5degC and 8.5degC - developed as part of Intergovernmental Panel on Climate Change's (IPCC) Fifth Assessment Report ([AR5](http://www.ipcc-data.org/sim/gcm_monthly/AR5/)).

As part of the study, the temperature data need to be modified to exclude land-based temperature measures but retaining SSTs (Sea Surface Temperatures). This will enable:

> ...supporting analysis, comparing the projected mean warming for all MPAs or all MPAs in a region (eg, the tropics) with the ambient (ie, whole ocean or region) warming rate. To answer the question: is warming in MPAs comparable, less, more than the oceans as a whole?

John Bruno, 2017

This notebook will provide code that removes the land surface temperatures from the CMIP5 surface temperature rasters.

## Setup

```{r}
# Packages
library(dplyr) # Data wrangling and exploration
library(tidyr) # Data wrangling
library(raster) # Dealing with rasters
library(ncdf4) # Required - viewing and working with climate data in netCDF format
```

## Approach


The approach I'll take is to select cells from the CMIP5 grid that fall *wholly* within the boundary of the world land surface polygon. This is because CMIP5 data is provided as a 360 \* 180 (1 \* 1 degree) grid. Raster-based analysis of temperatures - ie to quantify whole ocean or region warming - uses temperature data for each cell, so temperature values from single cells are what we're interested in. By only discarding cells that fall entirely within the land surface we ensure that SSTs for MPAs found within grid cells that overlap coastlines will be retained for analysis.

## Inspect CMIP5 RCP8.5 data 

Read CMIP5 RCP8.5
```{r}
name85 <- "../trend_yearmean_ensemble_tos_RCP85.nc"
mean85 <- raster(name85) # Read in raster
map.extent <- c(-180, 180, -90, 90) # Reset for layer, orginal orientation was 0-360 longitude
extent(mean85) <- map.extent # Change extent

source("../revrotate..R") # Rotate raster layer to align with MPA points
mean85 <- revrotate(mean85)
extent(mean85) <- map.extent
rm("name85", "map.extent")
```

Inspect structure and values using `ncdf4` package.

```{r}
nc <- nc_open(filename = name85) # Open connection to netCDF file
print(nc) # View dataset structure
nc_close(nc) # Close connection
rm("nc")
```


Inspect *Longitude and Latitude* grid.
```{r}
nc <- nc_open(filename = name85)
lon <- ncvar_get(nc = nc, varid = "lon") # Longitude named "lon" in netCDF
lat <- ncvar_get(nc = nc, varid = "lat") # Latitude named "lat" in netCDF

dim(lon); dim(lat)
head(lon); head(lat)

nc_close(nc) # Close connection
rm("lon", "lat", "nc")
```
Data is on a 1 \* 1 degree grid.

Inspect *Time* variable.
```{r}
nc <- nc_open(filename = name85)
t <- ncvar_get(nc = nc, varid = "time") # Time named "time" in netCDF

tunits <- ncatt_get(nc = nc, varid = "time", attname = "units")
dim(t)
tunits

nc_close(nc) # Close connection
rm("t", "tunits", "nc")
```
Only one time slice in the dataset.


Inspect *Temperature* variable.
```{r}
nc <- nc_open(filename = name85) # Open connection to netCDF file
print(nc) # View dataset structure

dname <- "tos" # name of variable found from `print(nc)`
tmp.df <- as_data_frame(ncvar_get(nc = nc, varid = dname)) # Get temperature (tmp) data 
colnames(tmp.df) <- 1:180
glimpse(tmp.df) # Peek at data

nc_close(nc)  # Close connection
rm("dname", "nc")
```
360 \* 180 dataset (1 \* 1 degree grid) of temperature trend values (? degree C / decade).

## Obtain world land surface raster data

Read in [Natural Earth](http://www.naturalearthdata.com/) 1:110m world vector, then convert to simple raster.

```{r}
# Natural Earth 110m data. Comes as zip file 
url <- "http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/110m/physical/ne_110m_land.zip" # web location

localDir <- "../data"

if (!file.exists(localDir)) {
  dir.create(localDir)
}

dwnld <- paste(localDir, basename(url), sep = "/") # zip file destination

if (!file.exists(dwnld)) {
  download.file(url = url, destfile = dwnld, method = "auto") # download from web
  unzip(dwnld, exdir = localDir) # unzip
}

list.files(localDir) # check unzip

rm("url", "localDir", "dwnld") # clean up workspace
```

## Mask raster with land vector


```{r read-land-vector}
library(rgdal) # For working with shapefiles
# localDir object from chunk `get-land-vector`. Alternatively, specify location of the land vector shapefile.

land <- readOGR(dsn = localDir) # Read in shapefile using `rgdal`. No need to specify shapefile name as there's only one in the directory we created above.
```

Mask raster to remove cells covered by land.
```{r}
mean85.sst <- mask(x = mean85, mask = land, inverse = TRUE)
```

### Check coastline cells

```{r}
xlims <- c(110, 150)
ylims <- c(-50, -10)

p.test <- gplot(mean85.sst) + # Note: uses `gplot` here not `ggplot` as this 
  geom_raster(aes(fill = value)) +
  scale_fill_viridis(direction = -1, option = "plasma", breaks = seq(0.02, 0.16, 0.02)) +
  # geom_polygon(data = land.gg, aes(x = long, y = lat, group = group), fill = "white") +
  geom_point(data = mpas, mapping = aes(x = Centroid_Longitude, y = Centroid_Latitude), size = 0.1, colour = "black") + 
  xlim(xlims) +
  ylim(ylims) +
  guides(fill = guide_colorbar(title = expression(paste(degree, C,"/decade")), barheight = 16, raster = TRUE)) + 
  theme(legend.title = element_text(size = 9)) +
  ggtitle("RCP 8.5 warming rate for mean SST") + 
  xlab("Longitude") +
  ylab("Latitude") +
  # scale_y_continuous(breaks = seq(-80, 80, 40), expand = c(0,0)) +
  # scale_x_continuous(breaks = seq(-180, 180, 60), expand = c(0,0)) + 
  geom_hline(yintercept = c(-66.5, -40, -23.5, 23.5, 40, 66.5), linetype = 2, size = 0.3)

p.test
```

